#
#   This file was adapted from
#   https://github.com/fredrik-johansson/arb/Makefile.in
#   and
#   https://github.com/edgarcosta/controlledreduction/blob/master/Makefile.in
#   See LICENCE or <http://www.gnu.org/licenses/> for more details.
#

# Variables set by autoconf
HDME_LIB=@HDME_LIB@
HDME_LIBNAME=@HDME_LIBNAME@
HDME_MAJOR=@HDME_MAJOR@
PREFIX=@prefix@
OS=@host_os@

INCS=@INCS@
LIBS=@LIBS@

CC=@CC@
AR=@AR@
ARFLAGS=@ARFLAGS@

CFLAGS=@CFLAGS@

EXEEXT=@EXEEXT@

# Local variables
HDME_PATH = $(CURDIR)
CFLAGS += -DHDME_PATH='"$(HDME_PATH)"'

# Configuration files generated by configure
CFG_FILES = Makefile hdme.pc config.status config.log
CFG_DIRS = autom4te.cache

LIBDIR=lib

MODULES = timing hdme_data polynomials siegel theta igusa hilbert hecke modular verbose

SOURCES = $(wildcard $(patsubst %, %/*.c, $(MODULES)))
HEADERS = $(patsubst %, %.h, $(MODULES))
OBJS = $(patsubst %.c, build/%.o, $(SOURCES))

TEST_SOURCES = $(wildcard $(patsubst %, %/test/t-*.c, $(MODULES)))
TESTS = $(patsubst %.c, build/%$(EXEEXT), $(TEST_SOURCES))
RUNTESTS = $(patsubst build/%, run/%, $(TESTS))

# Files to clean
CLEANFILES = $(HDME_LIB) $(HDME_LIBNAME) $(HDME_LIBNAME).$(HDME_MAJOR)

# Targets

all: library tests

check: library tests $(RUNTESTS)

tests: library $(TESTS)

clean:
	rm -rf build/
	rm -f $(CLEANFILES)

distclean: clean
	rm -f $(CFG_FILES)
	rm -rf $(CFG_DIRS)

library: shared

shared: $(HDME_LIB)

$(HDME_LIB): $(OBJS) $(SOURCES) $(HEADERS) | build
	@echo AR $(HDME_LIB)
	@$(AR) $(ARFLAGS) $(HDME_LIB) $(OBJS);
	ln -sf "$(HDME_LIB)" "$(HDME_LIBNAME)"; \
	ln -sf "$(HDME_LIB)" "$(HDME_LIBNAME).$(HDME_MAJOR)";

build:
	@mkdir -p build \
	$(foreach mod, $(MODULES), build/$(mod)) \
	$(foreach mod, $(MODULES), build/$(mod)/test) \

build/%.o: %.c $(HEADERS) | build
	@echo CC $<
	@$(CC) $(CFLAGS) $(INCS) -c $< -o $@

run/%: build/%
	@$<

$(TESTS): %: %.o $(OBJS)
	@echo CC $<
	@$(CC) $(CFLAGS) $(INCS) $^ -o $@ $(LIBS)

install: library
	mkdir -p $(PREFIX)/$(LIBDIR)
	mkdir -p $(PREFIX)/include/hdme
	mkdir -p $(PREFIX)/lib/pkgconfig
	cp $(HDME_LIB) "$(PREFIX)/$(LIBDIR)"
	cp -a $(shell ls $(HDME_LIBNAME)*) "$(PREFIX)/$(LIBDIR)"
	cp $(HEADERS) $(PREFIX)/include/hdme
	cp hdme.pc "$(PREFIX)/lib/pkgconfig/"
	if [ $(OS) = "Darwin" ]; then \
		install_name_tool -id "$(PREFIX)/$(LIBDIR)/$(HDME_LIB)" "$(PREFIX)/$(LIBDIR)/$(HDME_LIBNAME)"; \
	fi

print-%:
	@echo '$*=$($*)'

.PHONY: check clean distclean tests library shared examples build

